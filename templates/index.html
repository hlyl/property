<!DOCTYPE html>
<html>

<head>
  <title>Folium Map with SQLite</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
  <!-- Unique message to confirm the file is being edited -->
  <div style="text-align: center; margin-top: 20px;">
    <h1>Debugging Mode: You are editing the correct index.html file</h1>
  </div>

  <!-- Buttons to control data versions -->
  <div style="text-align: center; margin: 20px;">
    <form method="post" action="/filter" style="display:inline;">
      <input type="hidden" name="filter" value="all">
      <button type="submit" class="btn">Show All</button>
    </form>
    <form method="post" action="/filter" style="display:inline;">
      <input type="hidden" name="filter" value="new">
      <button type="submit" class="btn">Show New</button>
    </form>
  </div>

  <!-- Map iframe -->
  <iframe id="map-frame" src="{{ url_for('static', filename='map.html') }}" style="border:none;width:100%;height:100vh;"></iframe>

  <script>
    function saveMapStateAndSubmit(url) {
      var iframe = document.getElementById('map-frame');
      iframe.onload = function () {  // Wait for the iframe to load
        var map = iframe.contentWindow.map;
        if (map) {
          var zoom = map.getZoom();
          var center = map.getCenter();
          console.log('Saving map state: ', zoom, center);

          // Use Fetch API to send the POST request
          fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              zoom: zoom,
              center: JSON.stringify([center.lat, center.lng])
            })
          })
            .then(response => {
              if (response.ok) {
                console.log('Request succeeded with JSON response', response);
                window.location.reload(); // Reload the page after successful request
              } else {
                console.log('Request failed', response);
              }
            })
            .catch(error => {
              console.log('Fetch error: ', error);
            });

          console.log('POST request sent');
        } else {
          console.log('Map object not found in iframe.');
        }
      };
    }

    $(document).on('click', '.btn', function (e) {
      e.preventDefault();
      var url = $(this).closest('form').attr('action');
      console.log('Button clicked, form action URL: ', url);
      saveMapStateAndSubmit(url);
    });
  </script>

</body>

</html>